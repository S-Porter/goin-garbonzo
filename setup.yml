---
- hosts: localhost
  vars:
    - sheet_id: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        633565316238346361623530656233373135343737336165343035303238343735656562616262373837633664383139383965393764386436666530626432310a353363323534383162306131353134663264616365633962653231306635613064653161633035323163316434633165633231373266313862363562633331330a616633613963396635306433386235336361313639363733353534303031633264313265346333623638636135616138626664346337316536656336343539396536616333343462323639646230353636316335613530633632373933633337
    - client_secret: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        653330303733333736386562613363646437356664383334386361636334306165306335663339313265303932616634316566326134396432613336613535300a323862666334353236653639363266633538373035366464633834353761363938323033313462376164393634313437616535343633303266633864326139370a3139373631323732633231376463303863383936613132396234373763373966366134326436636233303464326335376162616534616238323135336538626165643866376536646266333364313330646236613032663932663461613563663035646438323937623262636661623237373066653135623661616336343734316632636166333365303837383362346430333464323130643066393965646438643061653834363234376433623333356263313963653832393765313938623763666262386531313231356336373532633030353866666533643565636563363439333966623465316237383131383839303262346333663732326136623932343832393063363433636338383732393333616331376662653863363536393830323938303438313733663233643730666434653138646536616338636433303236633938333937303863386237333639393035323733636633333062383662666361613933393965306134616133383937333961393639313562383063613163633234643135623530646563353032643739366633633964633835393237616666656661636433316236333466383537383566363662613730353332646361353738313635373736396535656532626631303661633538393538643064306462343063353533663035336539386638373236396662363537633966663064326130353264306133366430383266656466373231393835633564373864616535373435363063393463353433643265653164313964393335353736323637643933393137653737303338316661343265346233383466336562383566623266366539356538356164316637363037356437623039303031356462386237663735646139383739326331383439663762326531653131323631666462613036616530626539666533663538333563393661336265356230373935303736613961383362366130626565663962393030633265373962313533636366646165306138643261646231663532613036653035656630373864373361633137373333373837383731326237333961303264396634653933646463626630653765646535396261306132333933343463383336303436646135663036623764633864643636643030323966633462323862656134656363363630663466353238653139393136393963336530323531633264353131366565623530663933376231326238
    - venv_dir: '{{playbook_dir}}/tunes_venv'
  tasks:
    - copy: content='{{client_secret}}' dest={{playbook_dir}}/client_secret.json
    - template: src=templates/tunes.sh dest={{playbook_dir}}/get_tunes.sh mode=0777
    - apt: name={{item}} state=latest
      with_items:
        - virtualenv
        - python3-pip
        - libav-tools
      when: ansible_facts['pkg_mgr'] == 'apt'
      become: yes
    - pacman: name=python-pip,ffmpeg state=latest
      when: ansible_facts['pkg_mgr'] == 'pacman'
      become: yes
    - pip:
        name: '{{item}}'
        virtualenv: '{{venv_dir}}'
        state: latest
        virtualenv_command: /usr/bin/python3 -m venv
      with_items:
        - google-api-python-client
        - httplib2
        - oauth2client
        - pyasn1
        - pyasn1-modules
        - rsa
        - six
        - uritemplate
        - youtube-dl
    - file: src='{{playbook_dir}}/get_tunes.sh' dest=/usr/local/bin/tunes state=link
      become: yes
